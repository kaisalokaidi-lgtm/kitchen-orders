<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Ingredients</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            max-width: 1000px;
            margin: 0 auto;
        }
        .ingredient-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-badge {
            font-size: 0.875rem;
            margin-left: 10px;
        }
    </style>
</head>
<body class="container py-3 py-md-5">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>‚öôÔ∏è Admin - Manage Ingredients & Users</h2>
    <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
</div>

<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="ingredients-tab" data-bs-toggle="tab" href="#ingredients">Ingredients</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="users-tab" data-bs-toggle="tab" href="#users">Users</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#order-control">Order Control</a>
    </li>
</ul>

<div class="tab-content">
    <!-- Ingredients Tab -->
    <div class="tab-pane fade show active" id="ingredients" role="tabpanel">
        <div class="row mt-4">
            <div class="col-md-5">
                <h4>Add New Ingredient</h4>
                <form id="ingredientForm" class="mt-3">
                    <div class="mb-3">
                        <label class="form-label">Ingredient Name</label>
                        <input class="form-control" id="ingredientName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="category" required>
                            <option value="">Select category...</option>
                            <option value="salads">Salads</option>
                            <option value="sauces">Sauces</option>
                            <option value="drinks">Drinks</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Emoji (optional)</label>
                        <input class="form-control" id="emoji" placeholder="e.g., üçÖ">
                    </div>
                    <button class="btn btn-primary">Add Ingredient</button>
                </form>
                <div id="ingredient-success" class="alert alert-success mt-3 d-none">Ingredient added!</div>
            </div>

            <div class="col-md-7">
                <h4>Current Ingredients</h4>
                
                <div class="mt-3">
                    <h5>ü•ó Salads</h5>
                    <div id="salads-list"></div>
                </div>

                <div class="mt-4">
                    <h5>üçØ Sauces</h5>
                    <div id="sauces-list"></div>
                </div>

                <div class="mt-4">
                    <h5>ü•§ Drinks</h5>
                    <div id="drinks-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-pane fade" id="users" role="tabpanel">
        <div class="row mt-4">
            <div class="col-md-5">
                <h4>Add New User</h4>
                <form id="userForm" class="mt-3">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input class="form-control" id="userName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input class="form-control" id="userUsername" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="userPassword" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gender/Category</label>
                        <select class="form-select" id="userGender" required>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="kid">Kid</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="userRole" required>
                            <option value="user">User (Can order only)</option>
                            <option value="admin">Admin (Full access)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary">Add User</button>
                </form>
                <div id="user-success" class="alert alert-success mt-3 d-none">User added!</div>
            </div>

            <div class="col-md-7">
                <h4>Current Users</h4>
                <div id="users-list" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Order Control Tab -->
    <div class="tab-pane fade" id="order-control" role="tabpanel">
        <div class="row mt-4">
            <div class="col-md-6">
                <h4>Category Controls</h4>
                <p class="text-muted">Enable ordering by gender/category</p>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="allEnabled" onchange="updateCategorySetting('all_enabled', this.checked)">
                        <label class="form-check-label fw-bold">Enable All Users</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="maleEnabled" onchange="updateCategorySetting('male_enabled', this.checked)">
                        <label class="form-check-label">Enable Male Users üë®</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="femaleEnabled" onchange="updateCategorySetting('female_enabled', this.checked)">
                        <label class="form-check-label">Enable Female Users üë©</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="kidEnabled" onchange="updateCategorySetting('kid_enabled', this.checked)">
                        <label class="form-check-label">Enable Kids üë∂</label>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>Individual User Controls</h4>
                <p class="text-muted">Override for specific users</p>
                <div id="user-controls"></div>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="/" class="btn btn-outline-secondary">‚Üê Order Page</a>
    <a href="/kitchen" class="btn btn-outline-secondary">Kitchen View</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function loadIngredients() {
    const res = await fetch("/api/ingredients");
    const ingredients = await res.json();
    
    const salads = ingredients.filter(i => i.category === "salads");
    const sauces = ingredients.filter(i => i.category === "sauces");
    const drinks = ingredients.filter(i => i.category === "drinks");
    
    renderIngredients(salads, "salads-list");
    renderIngredients(sauces, "sauces-list");
    renderIngredients(drinks, "drinks-list");
}

function renderIngredients(ingredients, elementId) {
    const container = document.getElementById(elementId);
    if (ingredients.length === 0) {
        container.innerHTML = '<p class="text-muted">No ingredients</p>';
        return;
    }
    
    container.innerHTML = ingredients.map(ing => `
        <div class="ingredient-item">
            <span>${ing.emoji} ${ing.name}</span>
            <button class="btn btn-danger btn-sm" onclick="deleteIngredient(${ing.id})">Delete</button>
        </div>
    `).join('');
}

async function deleteIngredient(id) {
    if (!confirm('Are you sure you want to delete this ingredient?')) return;
    
    await fetch(`/api/ingredients/${id}`, { method: "DELETE" });
    await loadIngredients();
}

async function loadUsers() {
    const res = await fetch("/api/users");
    const users = await res.json();
    
    const container = document.getElementById("users-list");
    if (users.length === 0) {
        container.innerHTML = '<p class="text-muted">No users</p>';
        return;
    }
    
    const genderEmoji = {
        'male': 'üë®',
        'female': 'üë©',
        'kid': 'üë∂',
        'admin': '‚öôÔ∏è'
    };
    
    container.innerHTML = users.map(user => `
        <div class="ingredient-item">
            <div>
                <strong>${user.name}</strong> ${genderEmoji[user.gender] || ''}
                <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'} category-badge">${user.role}</span>
                <br>
                <small class="text-muted">Username: ${user.username}</small>
            </div>
            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})" ${user.id === '1' ? 'disabled' : ''}>
                ${user.id === '1' ? 'Protected' : 'Delete'}
            </button>
        </div>
    `).join('');
}

async function deleteUser(id) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    
    await fetch(`/api/users/${id}`, { method: "DELETE" });
    await loadUsers();
}

document.getElementById("ingredientForm").addEventListener("submit", async e => {
    e.preventDefault();
    const payload = {
        name: document.getElementById("ingredientName").value,
        category: document.getElementById("category").value,
        emoji: document.getElementById("emoji").value
    };
    
    await fetch("/api/ingredients", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });
    
    document.getElementById("ingredient-success").classList.remove("d-none");
    setTimeout(() => document.getElementById("ingredient-success").classList.add("d-none"), 2000);
    e.target.reset();
    await loadIngredients();
});

document.getElementById("userForm").addEventListener("submit", async e => {
    e.preventDefault();
    const payload = {
        name: document.getElementById("userName").value,
        username: document.getElementById("userUsername").value,
        password: document.getElementById("userPassword").value,
        gender: document.getElementById("userGender").value,
        role: document.getElementById("userRole").value
    };
    
    await fetch("/api/users", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });
    
    document.getElementById("user-success").classList.remove("d-none");
    setTimeout(() => document.getElementById("user-success").classList.add("d-none"), 2000);
    e.target.reset();
    await loadUsers();
    await loadOrderSettings();
});

async function loadOrderSettings() {
    const res = await fetch("/api/order-settings");
    const settings = await res.json();
    
    // Update category checkboxes
    document.getElementById("allEnabled").checked = settings.all_enabled;
    document.getElementById("maleEnabled").checked = settings.male_enabled;
    document.getElementById("femaleEnabled").checked = settings.female_enabled;
    document.getElementById("kidEnabled").checked = settings.kid_enabled;
    
    // Render user controls
    const genderEmoji = {
        'male': 'üë®',
        'female': 'üë©',
        'kid': 'üë∂'
    };
    
    const container = document.getElementById("user-controls");
    if (settings.users.length === 0) {
        container.innerHTML = '<p class="text-muted">No users to control</p>';
        return;
    }
    
    container.innerHTML = settings.users.map(user => `
        <div class="mb-2">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="user_${user.id}" 
                    ${user.can_order ? 'checked' : ''} 
                    onchange="updateUserSetting(${user.id}, this.checked)">
                <label class="form-check-label">${user.name} ${genderEmoji[user.gender] || ''}</label>
            </div>
        </div>
    `).join('');
}

async function updateCategorySetting(setting, enabled) {
    await fetch("/api/order-settings", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({[setting]: enabled})
    });
}

async function updateUserSetting(userId, enabled) {
    await fetch("/api/order-settings", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({user_id: userId, enabled: enabled})
    });
}

loadIngredients();
loadUsers();
loadOrderSettings();
</script>
</body>
</html>
