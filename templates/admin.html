<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Ingredients</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            max-width: 1000px;
            margin: 0 auto;
        }
        .ingredient-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-badge {
            font-size: 0.875rem;
            margin-left: 10px;
        }
    </style>
</head>
<body class="container py-3 py-md-5">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>‚öôÔ∏è Admin - Manage Ingredients & Users</h2>
    <div>
        <a href="/" class="btn btn-outline-secondary btn-sm">Order Page</a>
        <a href="/kitchen" class="btn btn-outline-secondary btn-sm">Kitchen</a>
        <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
    </div>
</div>

<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="ingredients-tab" data-bs-toggle="tab" href="#ingredients">Ingredients</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="users-tab" data-bs-toggle="tab" href="#users">Users</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#order-control">Order Control</a>
    </li>
</ul>

<div class="tab-content">
    <!-- Ingredients Tab -->
    <div class="tab-pane fade show active" id="ingredients" role="tabpanel">
        <div class="row mt-4">
            <div class="col-md-5">
                <h4 id="formTitle">Add New Ingredient</h4>
                <form id="ingredientForm" class="mt-3">
                    <input type="hidden" id="ingredientId" value="">
                    <div class="mb-3">
                        <label class="form-label">Ingredient Name</label>
                        <input class="form-control" id="ingredientName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="category" required>
                            <option value="">Select category...</option>
                            <option value="salads">Salads</option>
                            <option value="sauces">Sauces</option>
                            <option value="drinks">Drinks</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Emoji (optional)</label>
                        <input class="form-control" id="emoji" placeholder="e.g., üçÖ">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea class="form-control" id="description" rows="2" placeholder="Add a short description that will be shown as info"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Image URL (optional)</label>
                        <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg">
                        <small class="text-muted">Enter a URL to an image for this ingredient</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="submitBtn">Add Ingredient</button>
                        <button type="button" class="btn btn-secondary d-none" id="cancelBtn" onclick="cancelEdit()">Cancel</button>
                    </div>
                </form>
                <div id="ingredient-success" class="alert alert-success mt-3 d-none">Ingredient added!</div>
            </div>

            <div class="col-md-7">
                <h4>Current Ingredients</h4>
                
                <div class="mt-3">
                    <h5>ü•ó Salads</h5>
                    <div id="salads-list"></div>
                </div>

                <div class="mt-4">
                    <h5>üçØ Sauces</h5>
                    <div id="sauces-list"></div>
                </div>

                <div class="mt-4">
                    <h5>ü•§ Drinks</h5>
                    <div id="drinks-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-pane fade" id="users" role="tabpanel">
        <div class="row mt-4">
            <div class="col-md-5">
                <h4>Add New User</h4>
                <form id="userForm" class="mt-3">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input class="form-control" id="userName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gender/Category</label>
                        <select class="form-select" id="userGender" required>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="kid">Kid</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="userRole" required>
                            <option value="user">User (Can order only)</option>
                            <option value="admin">Admin (Full access)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="isDelivery">
                            <label class="form-check-label" for="isDelivery">üöö Delivery Person</label>
                        </div>
                        <small class="text-muted">Delivery users can collect and deliver orders</small>
                    </div>
                    <button class="btn btn-primary">Add User</button>
                </form>
                <div id="user-success" class="alert alert-success mt-3 d-none">User added!</div>
            </div>

            <div class="col-md-7">
                <h4>Current Users</h4>
                <div id="users-list" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Order Control Tab -->
    <div class="tab-pane fade" id="order-control" role="tabpanel">
        <div class="row mt-4">
            <div class="col-md-6">
                <h4>Quick Toggle Buttons</h4>
                <p class="text-muted">Toggle all users in a category from Individual User Controls</p>

                <div class="mb-3">
                    <button class="btn btn-primary w-100" onclick="toggleCategory('all', true)">
                        Enable All Users
                    </button>
                    <button class="btn btn-outline-secondary w-100 mt-2" onclick="toggleCategory('all', false)">
                        Disable All Users
                    </button>
                </div>

                <hr class="my-4">

                <div class="mb-3">
                    <button class="btn btn-primary w-100" onclick="toggleCategory('male', true)">
                        Enable Male Users üë®
                    </button>
                    <button class="btn btn-outline-secondary w-100 mt-2" onclick="toggleCategory('male', false)">
                        Disable Male Users üë®
                    </button>
                </div>

                <div class="mb-3">
                    <button class="btn btn-primary w-100" onclick="toggleCategory('female', true)">
                        Enable Female Users üë©
                    </button>
                    <button class="btn btn-outline-secondary w-100 mt-2" onclick="toggleCategory('female', false)">
                        Disable Female Users üë©
                    </button>
                </div>

                <div class="mb-3">
                    <button class="btn btn-primary w-100" onclick="toggleCategory('kid', true)">
                        Enable Kids üë∂
                    </button>
                    <button class="btn btn-outline-secondary w-100 mt-2" onclick="toggleCategory('kid', false)">
                        Disable Kids üë∂
                    </button>
                </div>

                <hr class="my-4">

                <div class="mb-3">
                    <h5 class="text-danger">‚ö†Ô∏è Danger Zone</h5>
                    <p class="text-muted small">Clear all orders from the database. This cannot be undone!</p>
                    <button class="btn btn-danger w-100" onclick="clearAllOrders()">
                        üóëÔ∏è Clear All Orders & Reset
                    </button>
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>Individual User Controls</h4>
                <p class="text-muted">Override for specific users</p>
                <div id="user-controls"></div>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrCodeModalLabel">Scan to Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="qrCodeImage" src="" alt="QR Code" class="img-fluid">
      </div>
    </div>
  </div>
</div>


<div class="mt-4">
    <a href="/" class="btn btn-outline-secondary">‚Üê Order Page</a>
    <a href="/kitchen" class="btn btn-outline-secondary">Kitchen View</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function loadIngredients() {
    const res = await fetch("/api/ingredients");
    const ingredients = await res.json();
    
    const salads = ingredients.filter(i => i.category === "salads");
    const sauces = ingredients.filter(i => i.category === "sauces");
    const drinks = ingredients.filter(i => i.category === "drinks");
    
    renderIngredients(salads, "salads-list");
    renderIngredients(sauces, "sauces-list");
    renderIngredients(drinks, "drinks-list");
}

function renderIngredients(ingredients, elementId) {
    const container = document.getElementById(elementId);
    if (ingredients.length === 0) {
        container.innerHTML = '<p class="text-muted">No ingredients</p>';
        return;
    }

    container.innerHTML = ingredients.map(ing => `
        <div class="ingredient-item">
            <span>${ing.emoji} ${ing.name}</span>
            <div>
                ${ing.description ? `<button class="btn btn-outline-info btn-sm me-2" onclick='showIngredientInfo(${JSON.stringify(ing.name)}, ${JSON.stringify(ing.description)})'>‚ÑπÔ∏è</button>` : ''}
                <button class="btn btn-primary btn-sm me-2" onclick='editIngredient(${JSON.stringify(ing)})'>Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteIngredient(${ing.id})">Delete</button>
            </div>
        </div>
    `).join('');
}

function editIngredient(ingredient) {
    // Populate form with ingredient data
    document.getElementById("ingredientId").value = ingredient.id;
    document.getElementById("ingredientName").value = ingredient.name;
    document.getElementById("category").value = ingredient.category;
    document.getElementById("emoji").value = ingredient.emoji || "";
    document.getElementById("description").value = ingredient.description || "";
    document.getElementById("imageUrl").value = ingredient.image_url || "";

    // Update UI for edit mode
    document.getElementById("formTitle").textContent = "Edit Ingredient";
    document.getElementById("submitBtn").textContent = "Update Ingredient";
    document.getElementById("cancelBtn").classList.remove("d-none");

    // Scroll to form
    document.getElementById("ingredientForm").scrollIntoView({ behavior: "smooth" });
}

function cancelEdit() {
    // Reset form
    document.getElementById("ingredientForm").reset();
    document.getElementById("ingredientId").value = "";

    // Update UI back to add mode
    document.getElementById("formTitle").textContent = "Add New Ingredient";
    document.getElementById("submitBtn").textContent = "Add Ingredient";
    document.getElementById("cancelBtn").classList.add("d-none");
}

async function deleteIngredient(id) {
    if (!confirm('Are you sure you want to delete this ingredient?')) return;

    await fetch(`/api/ingredients/${id}`, { method: "DELETE" });
    await loadIngredients();
}

async function loadUsers() {
    const res = await fetch("/api/users");
    const users = await res.json();
    
    const container = document.getElementById("users-list");
    if (users.length === 0) {
        container.innerHTML = '<p class="text-muted">No users</p>';
        return;
    }
    
    const genderEmoji = {
        'male': 'üë®',
        'female': 'üë©',
        'kid': 'üë∂',
        'admin': '‚öôÔ∏è'
    };
    
    container.innerHTML = users.map(user => `
        <div class="ingredient-item">
            <div>
                <strong>${user.name}</strong> ${genderEmoji[user.gender] || ''}
                <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'} category-badge">${user.role}</span>
                ${user.is_delivery === 'True' ? '<span class="badge bg-success category-badge">üöö Delivery</span>' : ''}
                <br>
                <small class="text-muted">Username: ${user.username}</small>
            </div>
            <div>
                <button class="btn btn-info btn-sm" onclick="showQrCode(${user.id}, '${user.name}')">Generate QR</button>
                <button class="btn btn-secondary btn-sm" onclick="copyMagicLink(event, ${user.id}, '${user.name}')">Copy Link</button>
                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})" ${user.id === '1' ? 'disabled' : ''}>
                    ${user.id === '1' ? 'Protected' : 'Delete'}
                </button>
            </div>
        </div>
    `).join('');
}

function showQrCode(userId, userName) {
    const qrCodeImage = document.getElementById('qrCodeImage');
    const qrCodeModalLabel = document.getElementById('qrCodeModalLabel');
    
    // Update modal title with user name
    qrCodeModalLabel.textContent = `Scan to Login - ${userName}`;
    
    // Add timestamp to force refresh the QR code
    qrCodeImage.src = `/api/user/${userId}/generate-qr?t=${Date.now()}`;
    
    const qrCodeModal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
    qrCodeModal.show();
}

async function copyMagicLink(event, userId, userName) {
    try {
        const response = await fetch(`/api/user/${userId}/magic-link`);
        const data = await response.json();
        
        if (data.magic_link) {
            await navigator.clipboard.writeText(data.magic_link);
            
            // Show feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úì Copied!';
            button.classList.remove('btn-secondary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
            }, 2000);
        }
    } catch (error) {
        alert('Failed to copy magic link');
        console.error(error);
    }
}

async function deleteUser(id) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    
    await fetch(`/api/users/${id}`, { method: "DELETE" });
    await loadUsers();
}

document.getElementById("ingredientForm").addEventListener("submit", async e => {
    e.preventDefault();

    const ingredientId = document.getElementById("ingredientId").value;
    const payload = {
        name: document.getElementById("ingredientName").value,
        category: document.getElementById("category").value,
        emoji: document.getElementById("emoji").value,
        image_url: document.getElementById("imageUrl").value,
        description: document.getElementById("description").value
    };

    // Determine if we're adding or editing
    const isEdit = ingredientId !== "";
    const url = isEdit ? `/api/ingredients/${ingredientId}` : "/api/ingredients";
    const method = isEdit ? "PUT" : "POST";

    await fetch(url, {
        method: method,
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });

    document.getElementById("ingredient-success").textContent = isEdit ? "Ingredient updated!" : "Ingredient added!";
    document.getElementById("ingredient-success").classList.remove("d-none");
    setTimeout(() => document.getElementById("ingredient-success").classList.add("d-none"), 2000);

    // Reset form and exit edit mode
    cancelEdit();
    await loadIngredients();
});

document.getElementById("userForm").addEventListener("submit", async e => {
    e.preventDefault();
    const name = document.getElementById("userName").value;
    const payload = {
        name: name,
        username: name.toLowerCase().replace(/\s+/g, ''),
        gender: document.getElementById("userGender").value,
        role: document.getElementById("userRole").value,
        is_delivery: document.getElementById("isDelivery").checked ? "True" : "False"
    };

    await fetch("/api/users", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });

    document.getElementById("user-success").classList.remove("d-none");
    setTimeout(() => document.getElementById("user-success").classList.add("d-none"), 2000);
    e.target.reset();
    await loadUsers();
    await loadOrderSettings();
});

async function loadOrderSettings() {
    const res = await fetch("/api/order-settings");
    const settings = await res.json();

    // Render user controls
    const genderEmoji = {
        'male': 'üë®',
        'female': 'üë©',
        'kid': 'üë∂'
    };

    const container = document.getElementById("user-controls");
    if (settings.users.length === 0) {
        container.innerHTML = '<p class="text-muted">No users to control</p>';
        return;
    }

    container.innerHTML = settings.users.map(user => `
        <div class="mb-2">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="user_${user.id}"
                    ${user.can_order ? 'checked' : ''}
                    onchange="updateUserSetting(${user.id}, this.checked)">
                <label class="form-check-label">${user.name} ${genderEmoji[user.gender] || ''}</label>
            </div>
        </div>
    `).join('');
}

async function toggleCategory(category, enabled) {
    await fetch("/api/order-settings", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({toggle_category: category, enabled: enabled})
    });
    // Reload to show updated checkboxes
    await loadOrderSettings();
}

async function updateUserSetting(userId, enabled) {
    await fetch("/api/order-settings", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({user_id: userId, enabled: enabled})
    });
}

async function clearAllOrders() {
    if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL orders (past and present) and reset the order counter to 1.\n\nUsers and ingredients will NOT be affected.\n\nThis action CANNOT be undone. Are you sure?')) {
        return;
    }
    
    // Double confirmation
    if (!confirm('Are you ABSOLUTELY sure? This is your last chance to cancel.')) {
        return;
    }
    
    try {
        const response = await fetch("/api/orders/clear-all", {
            method: "POST",
            headers: {"Content-Type": "application/json"}
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ All orders have been cleared successfully! Order counter has been reset to 1.');
            // Reload order settings to reflect changes
            await loadOrderSettings();
        } else {
            alert('‚ùå Failed to clear orders: ' + (data.message || 'Unknown error'));
        }
    } catch (error) {
        alert('‚ùå Error clearing orders: ' + error.message);
        console.error(error);
    }
}

// Show info modal for ingredient description (admin)
function showIngredientInfo(name, description) {
    const modalHtml = `
        <div class="modal fade" id="ingredientInfoModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">${name}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">${description}</div>
        </div></div></div>`;
    // Inject and show (clean up after)
    const temp = document.createElement('div');
    temp.innerHTML = modalHtml;
    document.body.appendChild(temp.firstChild);
    const bsModal = new bootstrap.Modal(document.getElementById('ingredientInfoModal'));
    bsModal.show();
    document.getElementById('ingredientInfoModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('ingredientInfoModal').remove();
    });
}

loadIngredients();
loadUsers();
loadOrderSettings();
</script>
</body>
</html>
