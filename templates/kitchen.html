<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        @media (max-width: 768px) {
            .container {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }
            h2 {
                font-size: 1.5rem;
            }
            .table {
                font-size: 0.875rem;
            }
            .badge {
                font-size: 0.7rem;
                margin-bottom: 2px;
            }
            .btn-sm {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
        }
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .order-row {
            cursor: pointer;
        }
        .order-row:hover {
            background-color: #f8f9fa;
        }
        .order-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-left: 3px solid #0d6efd;
        }
        .ingredient-check {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }
        .ingredient-check input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        .ingredient-check label {
            cursor: pointer;
            user-select: none;
            margin: 0;
        }
        .ingredient-check.checked label {
            text-decoration: line-through;
            color: #6c757d;
        }
        .badge-info-btn {
            background: transparent;
            border: none;
            color: #0d6efd;
            padding: 0 6px;
            font-weight: 600;
            cursor: pointer;
        }
        .badge-info-btn:hover { text-decoration: underline; }
        
        /* Info Modal Styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .image-modal.show {
            display: flex;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover,
        .close-modal:focus {
            color: #bbb;
        }
    </style>
</head>
<body class="container py-3 py-md-5">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üë®‚Äçüç≥ Kitchen Orders</h2>
    <div class="d-none d-md-block">
        <a href="/" class="btn btn-outline-secondary btn-sm">Order Page</a>
        <a href="/admin" class="btn btn-outline-secondary btn-sm">Admin</a>
        <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
    </div>
</div>

<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="pending-tab" data-bs-toggle="tab" href="#pending-section">‚è≥ Pending</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="preparing-tab" data-bs-toggle="tab" href="#preparing-section">üî• Preparing</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="ready-tab" data-bs-toggle="tab" href="#ready-section">‚úÖ Ready</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="out-for-delivery-tab" data-bs-toggle="tab" href="#out-for-delivery-section">üöö Out for Delivery</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="delivered-tab" data-bs-toggle="tab" href="#delivered-section">üìú Delivered</a>
    </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade show active" id="pending-section" role="tabpanel">
        <h4 class="mt-4 mb-3">‚è≥ Pending Orders</h4>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr><th>Order #</th><th>Person Type</th><th>Options</th><th></th></tr>
                </thead>
                <tbody id="pending-orders"></tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade" id="preparing-section" role="tabpanel">
        <h4 class="mb-3">üî• Preparing</h4>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr><th>Order #</th><th>Person Type</th><th>Options</th><th></th></tr>
                </thead>
                <tbody id="preparing-orders"></tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade" id="ready-section" role="tabpanel">
        <h4 class="mb-3">‚úÖ Ready for Delivery Pickup</h4>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr><th>Order #</th><th>Person Type</th><th>Options</th><th>Time</th></tr>
                </thead>
                <tbody id="ready-orders"></tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade" id="out-for-delivery-section" role="tabpanel">
        <h4 class="mb-3">üöö Out for Delivery</h4>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr><th>Order #</th><th>Person Type</th><th>Options</th><th>Collected By</th><th>Collected At</th></tr>
                </thead>
                <tbody id="out-for-delivery-orders"></tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade" id="delivered-section" role="tabpanel">
        <h4 class="mb-3">üìú Delivered Orders</h4>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr><th>Order #</th><th>Person Type</th><th>Options</th><th>Delivered By</th><th>Delivered At</th></tr>
                </thead>
                <tbody id="delivered-orders"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Info Modal -->
<div id="infoModal" class="image-modal" onclick="closeInfoModal(event)">
    <span class="close-modal" onclick="closeInfoModal(event)">&times;</span>
    <div id="infoModalContent" style="color:#fff;max-width:90%;padding:20px;"></div>
</div>

<script>
const OPTION_LABELS = {};
const OPTION_DESCRIPTIONS = {}; // new map

async function loadIngredientLabels() {
    const res = await fetch("/api/ingredients");
    const ingredients = await res.json();
    ingredients.forEach(ing => {
        const key = ing.name.toLowerCase().replace(/ /g, '_');
        OPTION_LABELS[key] = `${ing.name} ${ing.emoji}`;
        OPTION_DESCRIPTIONS[key] = ing.description || '';
    });
}

// Info modal helpers
function openInfoModalByKey(event, key) {
    event.preventDefault();
    event.stopPropagation();
    const desc = OPTION_DESCRIPTIONS[key];
    if (!desc) return;
    const modal = document.getElementById('infoModal');
    const content = document.getElementById('infoModalContent');
    content.innerHTML = `<h5 style="margin-bottom:8px;color:#fff">${OPTION_LABELS[key].split(' ')[0]}</h5><div style="color:#fff">${desc}</div>`;
    modal.classList.add('show');
}
function closeInfoModal(event) {
    const modal = document.getElementById('infoModal');
    modal.classList.remove('show');
}

let expandedOrderId = null;
let orderProgressCache = {};

async function loadOrders() {
    const res = await fetch("/api/orders");
    const orders = await res.json();

    const pendingOrders = orders.filter(o => o.status === "pending");
    const preparingOrders = orders.filter(o => o.status === "preparing");
    const readyOrders = orders.filter(o => o.status === "ready");
    const outForDeliveryOrders = orders.filter(o => o.status === "out_for_delivery");
    const deliveredOrders = orders.filter(o => o.status === "delivered");

    renderOrders(pendingOrders, "pending-orders", true, "pending");
    renderOrders(preparingOrders, "preparing-orders", true, "preparing");
    renderOrders(readyOrders, "ready-orders", false, "ready");
    renderOrders(outForDeliveryOrders, "out-for-delivery-orders", false, "out_for_delivery");
    renderOrders(deliveredOrders, "delivered-orders", false, "delivered");
}

async function updateCheck(orderId, ingredient, index) {
    const checkbox = document.getElementById(`ingredient-${orderId}-${index}`);
    const container = document.getElementById(`check-${orderId}-${index}`);
    
    if (checkbox.checked) {
        container.classList.add('checked');
    } else {
        container.classList.remove('checked');
    }
    
    // Save to backend
    await fetch(`/api/orders/${orderId}/progress`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            ingredient: ingredient,
            checked: checkbox.checked
        })
    });
    
    // Update cache
    if (!orderProgressCache[orderId]) {
        orderProgressCache[orderId] = [];
    }
    if (checkbox.checked) {
        if (!orderProgressCache[orderId].includes(ingredient)) {
            orderProgressCache[orderId].push(ingredient);
        }
    } else {
        orderProgressCache[orderId] = orderProgressCache[orderId].filter(i => i !== ingredient);
    }
}

async function markReady(id) {
    await fetch(`/api/orders/${id}/ready`, { method: "POST" });
    await updateOrderDisplay(id); // Targeted update for the single order
}

async function startOrder(orderId) {
    await fetch(`/api/orders/${orderId}/start`, { method: "POST" });
    expandedOrderId = parseInt(orderId); // Convert to integer
    await updateOrderDisplay(orderId); // Targeted update for the single order
}

async function cancelOrder(orderId) {
    if (confirm(`Are you sure you want to cancel Order #${orderId}?`)) {
        await fetch(`/api/orders/${orderId}/cancel`, { method: "POST" });
        await loadOrders(); // Reload to reflect the change
    }
}

// Function to render a single order row (main row)
// actionCellsHtml should contain one or more <td>...</td> cells as needed
function renderOrderRow(o, allowExpand, status, selectedIngredients, actionCellsHtml) {
    const rowClass = allowExpand ? 'order-row' : '';
    const rowClick = allowExpand ? `onclick="toggleOrder('${o.id}')"` : '';
    const badges = selectedIngredients.map(k => {
        const infoBtn = OPTION_DESCRIPTIONS[k] ? `<button class="badge-info-btn" onclick="event.stopPropagation(); openInfoModalByKey(event, '${k}')">‚ÑπÔ∏è</button>` : '';
        return `<span class="badge bg-secondary me-1 mb-1">${OPTION_LABELS[k]}${infoBtn}</span>`;
    }).join("");

    return `
    <tr class="${rowClass}" ${rowClick} id="order-main-row-${o.id}">
        <td><strong>#${o.id}</strong></td>
        <td>${o.person_type || '‚Äî'}</td>
        <td>${badges || "‚Äî"}</td>
        ${actionCellsHtml}
    </tr>`;
}

// Function to render expanded order details (checklist)
function renderExpandedOrderDetails(o, selectedIngredients, checkedIngredients) {
    return `
    <!-- colspan uses max number of columns in tables (5) to cover all table layouts -->
    <tr id="order-details-row-${o.id}">
        <td colspan="5" class="p-0">
            <div class="order-details">
                <h6 class="mb-3">üìã Checklist for Order #${o.id} (${o.person_type || 'Unknown'}):</h6>
                ${o.additional_instructions ? `<div class="alert alert-info mb-3"><strong>üìù Instructions:</strong> ${o.additional_instructions}</div>` : ''}
                ${selectedIngredients.length > 0 ? selectedIngredients.map((k, idx) => {
                    const isChecked = checkedIngredients.includes(k);
                    return `
                    <div class="ingredient-check ${isChecked ? 'checked' : ''}" id="check-${o.id}-${idx}">
                        <input type="checkbox" id="ingredient-${o.id}-${idx}" data-ingredient="${k}" ${isChecked ? 'checked' : ''} onchange="updateCheck('${o.id}', '${k}', ${idx})">
                        <label for="ingredient-${o.id}-${idx}">${OPTION_LABELS[k]}</label>
                    </div>
                `}).join("") : "<p class='text-muted'>No special ingredients</p>"}
                <div class="mt-3">
                    <button class="btn btn-success" onclick="markReady(${o.id})">‚úì Mark as Ready</button>
                </div>
            </div>
        </td>
    </tr>`;
}

// New function for targeted update of a single order
async function updateOrderDisplay(orderId) {
    // When a single order is updated, we simply reload all orders to ensure
    // consistency across all tabs and their respective counts.
    await loadOrders();
}

async function toggleOrder(orderId) {
    const numericOrderId = parseInt(orderId); // Convert to integer
    expandedOrderId = expandedOrderId === numericOrderId ? null : numericOrderId;
    await updateOrderDisplay(numericOrderId); // Update only the toggled order
}

async function renderOrders(orders, tbodyId, allowExpand, status) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = "";
    
    // Update tab count - ensure badge is always created and updated
    const tabLink = document.getElementById(`${status}-tab`);
    if (tabLink) {
        let countBadge = tabLink.querySelector('.badge');
        if (!countBadge) {
            countBadge = document.createElement('span');
            countBadge.classList.add('badge', 'bg-secondary', 'rounded-pill', 'ms-1');
            tabLink.appendChild(countBadge);
        }
        countBadge.textContent = orders.length;
    }
    
    if (orders.length === 0) {
        // use colspan=5 to cover the widest table (out-for-delivery/delivered)
        tbody.innerHTML = `<tr><td colspan="5" class="text-muted text-center">No orders</td></tr>`;
        return;
    }
    
    for (const o of orders) {
        const selectedIngredients = Object.keys(o).filter(k => 
            o[k] === "True" && OPTION_LABELS[k]
        );
        
        const isExpanded = expandedOrderId === o.id;
        
        // Load progress if expanded - ALWAYS refetch to ensure freshness
        if (isExpanded && allowExpand) {
            const progressRes = await fetch(`/api/orders/${o.id}/progress`);
            const progress = await progressRes.json();
            orderProgressCache[o.id] = progress.map(p => p.ingredient);
        }
        
        const checkedIngredients = orderProgressCache[o.id] || [];
        
        // Determine action cells (one or more <td>)
        let actionCells = '';
        if (status === 'pending') {
            actionCells = `<td>
                            <button class="btn btn-primary btn-sm me-2" onclick="event.stopPropagation(); startOrder(${o.id})">Start Preparing</button>
                            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); cancelOrder(${o.id})">Cancel</button>
                           </td>`;
        } else if (status === 'preparing') {
            actionCells = `<td>
                            <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); markReady(${o.id})">Mark Ready</button>
                            <button class="btn btn-danger btn-sm ms-2" onclick="event.stopPropagation(); cancelOrder(${o.id})">Cancel</button>
                           </td>`;
        } else if (status === 'ready') {
            actionCells = `<td>
                            ${new Date(o.timestamp).toLocaleTimeString()}
                            <button class="btn btn-danger btn-sm ms-2" onclick="event.stopPropagation(); cancelOrder(${o.id})">Cancel</button>
                           </td>`;
        } else if (status === 'out_for_delivery') {
            actionCells = `<td>${o.collected_by || ''}</td><td>${o.collected_at ? new Date(o.collected_at).toLocaleString() : ''}</td>`;
        } else if (status === 'delivered') {
            actionCells = `<td>${o.collected_by || o.delivered_by || ''}</td><td>${o.delivered_at ? new Date(o.delivered_at).toLocaleString() : ''}</td>`;
        } else {
            actionCells = `<td></td>`;
        }
        
        // Render and append new rows
        const newMainRow = renderOrderRow(o, allowExpand, status, selectedIngredients, actionCells);
        tbody.insertAdjacentHTML('beforeend', newMainRow);

        if (isExpanded && allowExpand) {
            const newDetailsRow = renderExpandedOrderDetails(o, selectedIngredients, checkedIngredients);
            document.getElementById(`order-main-row-${o.id}`).insertAdjacentHTML('afterend', newDetailsRow);
        }
    }
}

// Helper to get the currently active tab ID
function getActiveTabHash() {
    return window.location.hash ? window.location.hash.substring(1) : 'pending-section';
}

// Function to set the active tab
function setActiveTab(targetTabId) {
    // Deactivate current active tab link and content
    document.querySelectorAll('.nav-link.active').forEach(link => {
        link.classList.remove('active');
        link.removeAttribute('aria-current');
    });
    document.querySelectorAll('.tab-pane.show.active').forEach(pane => {
        pane.classList.remove('show', 'active');
    });

    // Activate the new tab link
    const newActiveLink = document.querySelector(`.nav-link[href="#${targetTabId}"]`);
    if (newActiveLink) {
        newActiveLink.classList.add('active');
        newActiveLink.setAttribute('aria-current', 'page');
    }

    // Activate the new tab content
    const newActivePane = document.getElementById(targetTabId);
    if (newActivePane) {
        newActivePane.classList.add('show', 'active');
    }
}

// Initial tab activation on page load
document.addEventListener('DOMContentLoaded', () => {
    setActiveTab(getActiveTabHash());

    // Event delegation for tab clicks
    document.querySelector('.nav-tabs').addEventListener('click', function (event) {
        const tabLink = event.target.closest('.nav-link');
        if (tabLink && !tabLink.classList.contains('active')) {
            event.preventDefault(); // Prevent default Bootstrap behavior
            const targetId = tabLink.getAttribute('href').substring(1);
            window.history.pushState(null, '', `#${targetId}`); // Update URL hash without page reload
            setActiveTab(targetId);
        }
    });

    // Listen for browser history changes (back/forward buttons)
    window.addEventListener('popstate', () => {
        setActiveTab(getActiveTabHash());
    });
});

loadIngredientLabels().then(() => {
    loadOrders();
    const socket = io();
    socket.on('connect', () => {
    });
    socket.on('update_orders', () => {
        loadOrders(); // For general updates not covered by specific order_updated events
    });
    socket.on('order_updated', (data) => {
        updateOrderDisplay(data.order_id);
    });
});
</script>

</body>
</html>
