<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @media (max-width: 768px) {
            .container {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }
            h2 {
                font-size: 1.5rem;
            }
            .table {
                font-size: 0.875rem;
            }
            .badge {
                font-size: 0.7rem;
                margin-bottom: 2px;
            }
            .btn-sm {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
        }
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .order-row {
            cursor: pointer;
        }
        .order-row:hover {
            background-color: #f8f9fa;
        }
        .order-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-left: 3px solid #0d6efd;
        }
        .ingredient-check {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }
        .ingredient-check input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        .ingredient-check label {
            cursor: pointer;
            user-select: none;
            margin: 0;
        }
        .ingredient-check.checked label {
            text-decoration: line-through;
            color: #6c757d;
        }
    </style>
</head>
<body class="container py-3 py-md-5">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üë®‚Äçüç≥ Kitchen Orders</h2>
    <a href="/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
</div>

<!-- Pending Orders -->
<div class="mb-5">
    <h4 class="mt-4 mb-3">‚è≥ Pending Orders</h4>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr><th>Order #</th><th>Name</th><th>Options</th><th></th></tr>
            </thead>
            <tbody id="pending-orders"></tbody>
        </table>
    </div>
</div>

<!-- Preparing Orders -->
<div class="mb-5">
    <h4 class="mb-3">üî• Preparing</h4>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr><th>Order #</th><th>Name</th><th>Options</th><th></th></tr>
            </thead>
            <tbody id="preparing-orders"></tbody>
        </table>
    </div>
</div>

<!-- Ready Orders -->
<div class="mb-5">
    <h4 class="mb-3">‚úÖ Ready for Delivery Pickup</h4>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr><th>Order #</th><th>Name</th><th>Options</th><th>Time</th></tr>
            </thead>
            <tbody id="ready-orders"></tbody>
        </table>
    </div>
</div>

<!-- Out for Delivery Orders -->
<div class="mb-5">
    <h4 class="mb-3">üöö Out for Delivery</h4>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr><th>Order #</th><th>Name</th><th>Options</th><th>Collected By</th><th>Collected At</th></tr>
            </thead>
            <tbody id="out-for-delivery-orders"></tbody>
        </table>
    </div>
</div>

<!-- Delivered Orders -->
<div class="mb-5">
    <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#deliveredSection">
        üìú Delivered Orders
    </button>
    <div class="collapse" id="deliveredSection">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr><th>Order #</th><th>Name</th><th>Options</th><th>Delivered By</th><th>Delivered At</th></tr>
                </thead>
                <tbody id="delivered-orders"></tbody>
            </table>
        </div>
    </div>
</div>
<script>
const OPTION_LABELS = {};

async function loadIngredientLabels() {
    const res = await fetch("/api/ingredients");
    const ingredients = await res.json();
    console.log("Loaded ingredients:", ingredients);
    ingredients.forEach(ing => {
        const key = ing.name.toLowerCase().replace(/ /g, '_');
        OPTION_LABELS[key] = `${ing.name} ${ing.emoji}`;
    });
    console.log("OPTION_LABELS:", OPTION_LABELS);
}

let expandedOrderId = null;
let orderProgressCache = {};

async function loadOrders() {
    const res = await fetch("/api/orders");
    const orders = await res.json();
    console.log("Loaded orders:", orders);
    console.log("OPTION_LABELS at loadOrders:", OPTION_LABELS);

    const pendingOrders = orders.filter(o => o.status === "pending");
    const preparingOrders = orders.filter(o => o.status === "preparing");
    const readyOrders = orders.filter(o => o.status === "ready");
    const outForDeliveryOrders = orders.filter(o => o.status === "out_for_delivery");
    const deliveredOrders = orders.filter(o => o.status === "delivered");

    await renderOrders(pendingOrders, "pending-orders", false, "pending");
    await renderOrders(preparingOrders, "preparing-orders", true, "preparing");
    await renderOrders(readyOrders, "ready-orders", false, "ready");
    await renderOutForDeliveryOrders(outForDeliveryOrders);
    await renderDeliveredOrders(deliveredOrders);
}

async function renderOrders(orders, tbodyId, allowExpand, status) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = "";
    
    if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-muted text-center">No orders</td></tr>`;
        return;
    }
    
    for (const o of orders) {
        // Find all keys in the order that are "True" and have labels
        const selectedIngredients = Object.keys(o).filter(k => 
            o[k] === "True" && OPTION_LABELS[k]
        );
        const badges = selectedIngredients.map(k =>
            `<span class="badge bg-secondary me-1 mb-1">${OPTION_LABELS[k]}</span>`
        ).join("");
        
        const isExpanded = expandedOrderId === o.id;
        
        // Load progress if expanded
        if (isExpanded && allowExpand && !orderProgressCache[o.id]) {
            const progressRes = await fetch(`/api/orders/${o.id}/progress`);
            const progress = await progressRes.json();
            orderProgressCache[o.id] = progress.map(p => p.ingredient);
        }
        
        const checkedIngredients = orderProgressCache[o.id] || [];
        const rowClass = allowExpand ? 'order-row' : '';
        const rowClick = allowExpand ? `onclick="toggleOrder('${o.id}')"` : '';
        
        // Determine action button
        let actionButton = '';
        if (status === 'pending') {
            actionButton = `<button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); startOrder(${o.id})">Start Preparing</button>`;
        } else if (status === 'ready') {
            actionButton = new Date(o.timestamp).toLocaleTimeString();
        }
        
        tbody.innerHTML += `
        <tr class="${rowClass}" ${rowClick}>
            <td><strong>#${o.id}</strong></td>
            <td>${o.name}</td>
            <td>${badges || "‚Äî"}</td>
            <td>${actionButton}</td>
        </tr>
        ${isExpanded && allowExpand ? `
        <tr>
            <td colspan="4" class="p-0">
                <div class="order-details">
                    <h6 class="mb-3">üìã Checklist for ${o.name}'s order:</h6>
                    ${selectedIngredients.length > 0 ? selectedIngredients.map((k, idx) => {
                        const isChecked = checkedIngredients.includes(k);
                        return `
                        <div class="ingredient-check ${isChecked ? 'checked' : ''}" id="check-${o.id}-${idx}">
                            <input type="checkbox" id="ingredient-${o.id}-${idx}" data-ingredient="${k}" ${isChecked ? 'checked' : ''} onchange="updateCheck('${o.id}', '${k}', ${idx})">
                            <label for="ingredient-${o.id}-${idx}">${OPTION_LABELS[k]}</label>
                        </div>
                    `}).join("") : "<p class='text-muted'>No special ingredients</p>"}
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="markReady(${o.id})">‚úì Mark as Ready</button>
                    </div>
                </div>
            </td>
        </tr>
        ` : ""}`;
    }
}

async function startOrder(orderId) {
    await fetch(`/api/orders/${orderId}/start`, { method: "POST" });
    expandedOrderId = orderId; // Auto-expand the order
    await loadOrders();
}

async function toggleOrder(orderId) {
    expandedOrderId = expandedOrderId === orderId ? null : orderId;
    await loadOrders();
}

async function updateCheck(orderId, ingredient, index) {
    const checkbox = document.getElementById(`ingredient-${orderId}-${index}`);
    const container = document.getElementById(`check-${orderId}-${index}`);
    
    if (checkbox.checked) {
        container.classList.add('checked');
    } else {
        container.classList.remove('checked');
    }
    
    // Save to backend
    await fetch(`/api/orders/${orderId}/progress`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            ingredient: ingredient,
            checked: checkbox.checked
        })
    });
    
    // Update cache
    if (!orderProgressCache[orderId]) {
        orderProgressCache[orderId] = [];
    }
    if (checkbox.checked) {
        if (!orderProgressCache[orderId].includes(ingredient)) {
            orderProgressCache[orderId].push(ingredient);
        }
    } else {
        orderProgressCache[orderId] = orderProgressCache[orderId].filter(i => i !== ingredient);
    }
    
    // Reload to update status
    await loadOrders();
}
async function markReady(id) {
    await fetch(`/api/orders/${id}/ready`, { method: "POST" });
    loadOrders();
}

async function renderOutForDeliveryOrders(orders) {
    const tbody = document.getElementById("out-for-delivery-orders");
    tbody.innerHTML = "";

    if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-muted text-center">No orders out for delivery</td></tr>`;
        return;
    }

    for (const o of orders) {
        const selectedIngredients = Object.keys(o).filter(k =>
            o[k] === "True" && OPTION_LABELS[k]
        );
        const badges = selectedIngredients.map(k =>
            `<span class="badge bg-secondary me-1 mb-1">${OPTION_LABELS[k]}</span>`
        ).join("");

        const collectedAt = o.collected_at ? new Date(o.collected_at).toLocaleString() : 'N/A';

        tbody.innerHTML += `
        <tr>
            <td><strong>#${o.id}</strong></td>
            <td>${o.name}</td>
            <td>${badges || "‚Äî"}</td>
            <td>${o.collected_by || 'N/A'}</td>
            <td>${collectedAt}</td>
        </tr>`;
    }
}

async function renderDeliveredOrders(orders) {
    const tbody = document.getElementById("delivered-orders");
    tbody.innerHTML = "";

    if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-muted text-center">No delivered orders</td></tr>`;
        return;
    }

    // Show most recent 20
    const recentOrders = orders.slice(-20).reverse();

    for (const o of recentOrders) {
        const selectedIngredients = Object.keys(o).filter(k =>
            o[k] === "True" && OPTION_LABELS[k]
        );
        const badges = selectedIngredients.map(k =>
            `<span class="badge bg-secondary me-1 mb-1">${OPTION_LABELS[k]}</span>`
        ).join("");

        const deliveredAt = o.delivered_at ? new Date(o.delivered_at).toLocaleString() : 'N/A';

        tbody.innerHTML += `
        <tr>
            <td><strong>#${o.id}</strong></td>
            <td>${o.name}</td>
            <td>${badges || "‚Äî"}</td>
            <td>${o.collected_by || 'N/A'}</td>
            <td>${deliveredAt}</td>
        </tr>`;
    }
}

loadIngredientLabels().then(() => {
    loadOrders();
    setInterval(loadOrders, 2000);
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
